# 功能需求詳細說明

[← 返回文件中心](../README.md) | [需求文件](../requirements/) | **功能需求**

## 文件資訊

- **版本**: 1.0.0
- **最後更新**: 2025-08-20
- **目標讀者**: 產品經理、開發者、測試工程師
- **相關文件**: 
  - [非功能需求](./non-functional.md)
  - [使用案例](./use-cases.md)
  - [API 設計規格](../api/design-spec.md)

## 功能需求總覽

| **模組**           | **功能 ID** | **功能描述**                                                 | **優先級** |
| ------------------ | ----------- | ------------------------------------------------------------ | ---------- |
| **產品管理**       | PROD-01     | 系統應提供 API，允許使用者獲取產品列表，並支援篩選、排序與分頁。 | 高         |
|                    | PROD-02     | 系統應提供 API，允許使用者透過 ID 獲取單一產品的詳細資訊。     | 高         |
|                    | PROD-03     | 系統應提供受保護的 API，允許授權使用者新增產品。               | 中         |
|                    | PROD-04     | 系統應提供受保護的 API，允許授權使用者更新指定 ID 的產品資訊。 | 中         |
|                    | PROD-05     | 系統應提供受保護的 API，允許授權使用者刪除指定 ID 的產品。     | 中         |
| **分類與篩選**     | CAT-01      | 系統應提供 API，允許使用者獲取所有產品分類的列表。             | 高         |
|                    | CAT-02      | 系統應提供 API，允許使用者獲取特定分類下的所有產品。           | 高         |
| **使用者與購物車** | USER-01     | 系統應提供 API，允許當前登入使用者獲取自己的詳細資訊。         | 高         |
|                    | USER-02     | 系統應提供 API，允許管理者獲取指定 ID 的使用者詳細資訊。 (練習用) | 低         |
|                    | CART-01     | 系統應提供 API，讓已驗證的使用者能夠將產品加入自己的購物車。   | 高         |
|                    | CART-02     | 系統應提供 API，讓已驗證的使用者能夠更新自己購物車中產品的數量。 | 高         |
|                    | CART-03     | 系統應提供 API，讓已驗證的使用者能夠從自己購物車中移除產品。   | 高         |
|                    | CART-04     | 系統應提供 API，讓已驗證的使用者能夠獲取自己購物車的內容。     | 高         |
|                    | CART-05     | 系統應提供 API，允許管理者查看指定使用者的購物車內容。(練習用) | 低         |
| **認證與授權**     | AUTH-01     | 系統應提供 API，讓使用者透過帳號密碼登入並獲取 JWT。         | 高         |
|                    | AUTH-02     | 系統應支援 Google OAuth 2.0 使用者授權流程。(學習用)       | 低         |
|                    | AUTH-03     | 系統應支援簡單的 API Key 認證機制。(學習用) | 低         |
| **金流支付**       | PAY-01      | 系統應提供 API，為使用者的購物車發起一個基於 Stripe 的模擬支付流程。 | 高         |
|                    | PAY-02      | 系統應提供 Webhook 端點，用於接收和處理來自 Stripe 的支付狀態更新。 | 高         |

## 詳細功能規格

### 1. 產品管理模組

#### PROD-01: 產品列表查詢

**功能描述**
- 提供產品列表查詢功能，支援多種篩選條件
- 支援分頁機制，避免一次載入過多資料
- 支援多欄位排序

**接受條件**
- [ ] 支援按分類篩選產品
- [ ] 支援按價格範圍篩選
- [ ] 支援按產品名稱搜尋
- [ ] 支援分頁（預設每頁 20 筆）
- [ ] 支援按價格、名稱、建立時間排序
- [ ] 回應時間 < 500ms

**API 端點**
```
GET /v1/products
```

**查詢參數**
- `page_size`: 每頁筆數（1-100，預設 20）
- `page_token`: 分頁令牌
- `filter`: 篩選條件（AIP-160 語法）
- `order_by`: 排序欄位

#### PROD-02: 單一產品查詢

**功能描述**
- 根據產品 ID 獲取完整產品資訊
- 包含產品的所有屬性和關聯資料

**接受條件**
- [ ] 返回產品完整資訊
- [ ] 包含分類名稱
- [ ] 包含庫存狀態
- [ ] 不存在的產品返回 404
- [ ] 回應時間 < 200ms

**API 端點**
```
GET /v1/products/{id}
```

#### PROD-03: 新增產品

**功能描述**
- 允許管理員新增產品到系統
- 需要管理員權限

**接受條件**
- [ ] 需要有效的 JWT Token
- [ ] 需要管理員角色
- [ ] 驗證必填欄位
- [ ] 驗證價格為正數
- [ ] 驗證分類 ID 存在
- [ ] 成功返回新產品資訊和 201 狀態碼

**API 端點**
```
POST /v1/products
```

**請求內容**
```json
{
  "name": "產品名稱",
  "description": "產品描述",
  "price": 99.99,
  "category_id": "cat_electronics",
  "image_url": "https://example.com/image.jpg",
  "sku": "SKU-001",
  "stock_quantity": 100
}
```

### 2. 分類與篩選模組

#### CAT-01: 分類列表

**功能描述**
- 獲取所有可用的產品分類
- 包含每個分類的產品數量

**接受條件**
- [ ] 返回所有啟用的分類
- [ ] 包含分類下的產品數量
- [ ] 支援階層式分類結構
- [ ] 可快取 5 分鐘

**API 端點**
```
GET /v1/categories
```

#### CAT-02: 分類產品查詢

**功能描述**
- 獲取特定分類下的所有產品
- 支援分頁和排序

**接受條件**
- [ ] 返回指定分類的產品
- [ ] 支援分頁機制
- [ ] 支援排序選項
- [ ] 不存在的分類返回 404

**API 端點**
```
GET /v1/categories/{id}/products
```

### 3. 使用者與購物車模組

#### USER-01: 當前使用者資訊

**功能描述**
- 獲取當前登入使用者的個人資訊
- 需要有效的認證

**接受條件**
- [ ] 需要有效的 JWT Token
- [ ] 返回使用者基本資訊
- [ ] 不包含敏感資訊（如密碼）
- [ ] 包含 OAuth 連結狀態

**API 端點**
```
GET /v1/users/me
```

#### CART-01: 加入購物車

**功能描述**
- 將產品加入使用者的購物車
- 自動處理數量累加

**接受條件**
- [ ] 需要有效的認證
- [ ] 驗證產品存在
- [ ] 驗證庫存充足
- [ ] 相同產品自動累加數量
- [ ] 返回更新後的購物車

**API 端點**
```
POST /v1/users/me/cart/items
```

**請求內容**
```json
{
  "product_id": "prod_123",
  "quantity": 2
}
```

#### CART-02: 更新購物車商品

**功能描述**
- 更新購物車中特定商品的數量
- 數量為 0 時自動移除

**接受條件**
- [ ] 需要有效的認證
- [ ] 驗證商品在購物車中
- [ ] 驗證新數量的庫存
- [ ] 數量為 0 時移除商品
- [ ] 返回更新後的購物車

**API 端點**
```
PUT /v1/users/me/cart/items/{item_id}
```

#### CART-03: 移除購物車商品

**功能描述**
- 從購物車中移除指定商品

**接受條件**
- [ ] 需要有效的認證
- [ ] 驗證商品在購物車中
- [ ] 成功移除返回 204
- [ ] 返回更新後的購物車

**API 端點**
```
DELETE /v1/users/me/cart/items/{item_id}
```

#### CART-04: 查看購物車

**功能描述**
- 獲取當前使用者的購物車內容
- 包含商品詳情和總金額

**接受條件**
- [ ] 需要有效的認證
- [ ] 返回購物車所有商品
- [ ] 包含每個商品的詳細資訊
- [ ] 計算總金額
- [ ] 標示缺貨商品

**API 端點**
```
GET /v1/users/me/cart
```

### 4. 認證與授權模組

#### AUTH-01: 使用者登入

**功能描述**
- 使用者透過帳號密碼登入
- 返回 JWT Token

**接受條件**
- [ ] 驗證帳號存在
- [ ] 驗證密碼正確
- [ ] 返回有效的 JWT Token
- [ ] Token 有效期 15 分鐘
- [ ] 包含 Refresh Token
- [ ] 記錄登入時間

**API 端點**
```
POST /v1/auth/login
```

**請求內容**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

#### AUTH-02: Google OAuth 登入

**功能描述**
- 支援 Google OAuth 2.0 登入
- 自動建立或關聯使用者帳號

**接受條件**
- [ ] 重導向到 Google 授權頁面
- [ ] 處理授權回調
- [ ] 自動建立新使用者或關聯既有帳號
- [ ] 返回 JWT Token
- [ ] 記錄 OAuth 提供者資訊

**API 端點**
```
GET /v1/auth/google
GET /v1/auth/google/callback
```

### 5. 金流支付模組

#### PAY-01: 發起支付

**功能描述**
- 為購物車內容建立 Stripe 支付會話
- 重導向到 Stripe 支付頁面

**接受條件**
- [ ] 需要有效的認證
- [ ] 驗證購物車不為空
- [ ] 驗證所有商品庫存
- [ ] 建立 Stripe 支付會話
- [ ] 返回支付頁面 URL
- [ ] 建立待支付訂單

**API 端點**
```
POST /v1/users/me/cart/checkout
```

**請求內容**
```json
{
  "success_url": "https://example.com/success",
  "cancel_url": "https://example.com/cancel"
}
```

#### PAY-02: 支付 Webhook

**功能描述**
- 接收 Stripe 支付狀態更新
- 更新訂單狀態

**接受條件**
- [ ] 驗證 Stripe 簽名
- [ ] 處理支付成功事件
- [ ] 處理支付失敗事件
- [ ] 更新訂單狀態
- [ ] 扣減商品庫存
- [ ] 清空購物車

**API 端點**
```
POST /v1/webhooks/stripe
```

## 功能優先級矩陣

| 優先級 | 功能模組 | 實作順序 | 預估工時 |
|--------|----------|----------|----------|
| P0 - 必要 | 產品查詢 (PROD-01, PROD-02) | 第 1 週 | 16 小時 |
| P0 - 必要 | 使用者認證 (AUTH-01) | 第 1 週 | 12 小時 |
| P0 - 必要 | 分類管理 (CAT-01, CAT-02) | 第 2 週 | 8 小時 |
| P1 - 重要 | 購物車功能 (CART-01~04) | 第 2-3 週 | 20 小時 |
| P1 - 重要 | 產品管理 (PROD-03~05) | 第 3 週 | 12 小時 |
| P2 - 次要 | 支付整合 (PAY-01, PAY-02) | 第 4 週 | 16 小時 |
| P3 - 可選 | OAuth 登入 (AUTH-02) | 第 4 週 | 8 小時 |

## 相關文件

- [非功能需求](./non-functional.md) - 效能、安全、可用性要求
- [API 設計規格](../api/design-spec.md) - 詳細 API 文件
- [資料庫設計](../architecture/database-schema.md) - 資料模型設計
- [測試策略](../implementation/testing-strategy.md) - 測試計畫

---

*本文件是 Fake Store API 專案的一部分*