# 資料庫關聯設計與實體設計

本文件提供 Fake Store API 中使用的資料庫關聯與實體設計模式的視覺化概覽。

## 實體關聯概覽

### 核心業務實體

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│ categories  │←──────→ │  products   │←──────→ │ cart_items  │
│             │  1:N    │             │  1:N    │             │
│ - id        │         │ - id        │         │ - cart_id   │
│ - name      │         │ - name      │         │ - product_id│
│ - is_active │         │ - price     │         │ - quantity  │
└─────────────┘         │ - stock     │         └─────────────┘
                        │ - is_active │                 ↑
                        └─────────────┘                 │1:N
                                │                       │
                                │1:N                    │
                                ↓                ┌─────────────┐
                        ┌─────────────┐         │    carts    │
                        │order_items  │         │             │
                        │             │         │ - id        │
                        │ - order_id  │         │ - user_id   │
                        │ - product_id│         │ - session_id│
                        │ - quantity  │         └─────────────┘
                        │ - unit_price│                 ↑
                        └─────────────┘                 │1:1
                                ↑                       │
                                │N:1              ┌─────────────┐
                                │                 │    users    │
                        ┌─────────────┐          │             │
                        │   orders    │←─────────│ - id        │
                        │             │   1:N    │ - email     │
                        │ - id        │          │ - password  │
                        │ - user_id   │          │ - is_active │
                        │ - status    │          └─────────────┘
                        │ - total     │                 ↑
                        └─────────────┘                 │1:N
                                                        │
                                                ┌─────────────┐
                                                │oauth_providers│
                                                │             │
                                                │ - user_id   │
                                                │ - provider  │
                                                │ - tokens    │
                                                └─────────────┘
```

## 關聯類型與業務規則

### 1. 產品目錄關聯

**分類 → 產品 (1:N)**
- 每個產品屬於唯一分類
- 分類可包含多個產品
- 串聯規則: 刪除分類時採用 RESTRICT（保護資料完整性）
- 業務規則: 產品繼承分類的顯示規則

**產品 → 購物車項目 (1:N)**
- 每個產品可出現在多個購物車中
- 每個購物車項目引用唯一產品
- 串聯規則: 刪除產品時採用 CASCADE（自動清理）
- 業務規則: 購物車項目保存價格快照

**產品 → 訂單項目 (1:N)**
- 每個產品可出現在多個訂單中
- 每個訂單項目引用唯一產品
- 串聯規則: 刪除產品時採用 RESTRICT（保留訂單歷史）
- 業務規則: 訂單項目保存完整產品快照

### 2. 使用者管理關聯

**使用者 → 購物車 (1:1)**
- 每個已認證使用者有唯一購物車
- 訪客使用者使用基於工作階段的購物車
- 串聯規則: 刪除使用者時採用 CASCADE
- 業務規則: user_id 與 session_id 互斥（XOR 限制）

**使用者 → 訂單 (1:N)**
- 每個使用者可有多個訂單
- 每個訂單屬於唯一使用者
- 串聯規則: 刪除使用者時採用 RESTRICT（保留訂單歷史）
- 業務規則: 付款後訂單不可變更

**使用者 → OAuth 提供者 (1:N)**
- 每個使用者可連結多個 OAuth 提供者
- 每個 OAuth 連結屬於唯一使用者
- 串聯規則: 刪除使用者時採用 CASCADE
- 業務規則: (user_id, provider) 唯一約束

### 3. 購物與訂單關聯

**購物車 → 購物車項目 (1:N)**
- 每個購物車可包含多個項目
- 每個購物車項目屬於唯一購物車
- 串聯規則: 刪除購物車時採用 CASCADE
- 業務規則: 數量必須為正數，每個產品在購物車中唯一

**訂單 → 訂單項目 (1:N)**
- 每個訂單包含多個項目
- 每個訂單項目屬於唯一訂單
- 串聯規則: 刪除訂單時採用 CASCADE
- 業務規則: 項目不可變更，total_price 為計算欄位

## 資料完整性設計模式

### 1. 不可變稽核軌跡
```sql
-- 訂單項目保存完整產品快照
order_items: {
  product_id,      -- 用於報表的引用
  product_name,    -- 用於顯示的快照
  unit_price,      -- 訂單時的價格
  quantity,        -- 訂購數量
  total_price      -- 計算欄位
}
```

### 2. 軟刪除模式
```sql
-- 保持資料完整性同時支援「刪除」
products: {
  is_active: boolean,  -- 軟刪除標記
  updated_at: timestamp -- 稽核軌跡
}
```

### 3. 價格快照模式
```sql
-- 購物車項目捕獲加入時的價格
cart_items: {
  unit_price: decimal(10,2)  -- 價格快照
}

-- 訂單項目捕獲結帳時的價格
order_items: {
  unit_price: decimal(10,2)  -- 最終價格
}
```

### 4. 互斥模式
```sql
-- 購物車支援已認證與訪客使用者
carts: {
  user_id: varchar(50),     -- 已認證使用者
  session_id: varchar(255), -- 訪客使用者
  -- 約束: 必須設定其中一個
  CHECK ((user_id IS NOT NULL AND session_id IS NULL) OR 
         (user_id IS NULL AND session_id IS NOT NULL))
}
```

## 效能設計模式

### 1. 策略性索引
- **查詢模式**: Email、使用者名稱、產品分類
- **搜尋模式**: 產品名稱/描述的全文搜尋
- **時間模式**: 訂單歷史、最新產品
- **狀態模式**: 有效產品、訂單狀態過濾

### 2. 為效能而反正規化
- **訂單中的產品快照**: 避免訂單顯示時的關聯查詢
- **產品回應中的分類名稱**: 減少查詢複雜度
- **計算欄位**: order_items 中的 total_price

### 3. 分割準備
- **基於時間**: 按日期分割訂單和使用者活動
- **基於狀態**: 有效與無效產品分離
- **基於使用者**: 大型使用者表按區域/群組分割

## 安全性與隱私模式

### 1. 敏感資料保護
```sql
users: {
  password_hash,           -- bcrypt 雜湊密碼
  email                    -- 具有存取控制的 PII
}

user_oauth_providers: {
  access_token_hash,       -- 加密 Token 存儲
  refresh_token_hash       -- 加密更新 Token
}
```

### 2. 存取控制準備
- **使用者所有權**: 直接的 user_id 外鍵
- **管理存取**: 獨立的 oauth_clients 表
- **工作階段管理**: 透過 session_id 隔離訪客購物車

### 3. 稽核軌跡基礎
- **時間戳追蹤**: 所有表的 created_at、updated_at
- **變更偵測**: 自動的 updated_at 觸發器
- **使用者活動**: 活動日誌的框架準備