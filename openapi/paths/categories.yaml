# 分類相關 API 端點定義
categories_collection:
  get:
    tags:
      - Categories
    summary: 列出產品分類
    description: |
      獲取所有產品分類列表。
      
      ## 特色功能（admin 可見 include_deleted=true）
      - 支援階層分類結構
      - 包含產品計數資訊
      - 支援排序與篩選
      
    operationId: listCategories
    parameters:
      - name: include_deleted
        in: query
        description: 是否包含已軟刪除的資源（僅管理員）
        schema:
          type: boolean
          default: false
      - name: only_deleted
        in: query
        description: 僅返回已軟刪除的資源（僅管理員，與 include_deleted 互斥）
        schema:
          type: boolean
          default: false
      - name: include_inactive
        in: query
        description: 是否包含停用的分類
        schema:
          type: boolean
          default: false
      - name: order_by
        in: query
        description: 排序欄位和方向
        schema:
          type: string
          default: "name asc"
          enum: ["name asc", "name desc", "created_at asc", "created_at desc"]
    responses:
      '200':
        description: 成功返回分類列表
        content:
          application/json:
            schema:
              $ref: '../components/schemas/category.yaml#/CategoryList'
        headers:
          Cache-Control:
            description: 快取控制
            schema:
              type: string
              example: "public, max-age=600"
      '400':
        $ref: '../components/responses/errors.yaml#/BadRequest'
      '500':
        $ref: '../components/responses/errors.yaml#/InternalError'
    security:
      - OAuth2: ['read']
      - ApiKeyBearer: []
  
  post:
    tags:
      - Categories
    summary: 建立分類
    description: 建立新的產品分類，需要管理員權限
    operationId: createCategory
    security:
      - OAuth2: ['write', 'admin']
      - ApiKeyBearer: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/category.yaml#/CreateCategoryRequest'
          examples:
            basic_category:
              summary: 基本分類建立
              value:
                name: "Electronics"
                description: "Electronic devices and accessories"
                parent_id: null
    responses:
      '201':
        description: 分類建立成功
        content:
          application/json:
            schema:
              $ref: '../components/schemas/category.yaml#/Category'
        headers:
          Location:
            description: 新建立分類的 URL
            schema:
              type: string
              format: uri
      '400':
        $ref: '../components/responses/errors.yaml#/ValidationError'
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

categories_item:
  get:
    tags:
      - Categories
    summary: 取得分類詳情
    description: 根據分類 ID 獲取詳細分類資訊
    operationId: getCategory
    parameters:
      - name: id
        in: path
        required: true
        description: 分類 ID
        schema:
          type: string
          pattern: '^cat_[a-zA-Z0-9]+$'
          example: "cat_electronics"
    responses:
      '200':
        description: 成功返回分類詳情
        content:
          application/json:
            schema:
              $ref: '../components/schemas/category.yaml#/Category'
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'
      '500':
        $ref: '../components/responses/errors.yaml#/InternalError'
    security:
      - OAuth2: ['read']
      - ApiKeyBearer: []
  
  patch:
    tags:
      - Categories
    summary: 更新分類
    description: 部分更新分類資訊，需要管理員權限
    operationId: updateCategory
    security:
      - OAuth2: ['write', 'admin']
      - ApiKeyBearer: []
    parameters:
      - name: id
        in: path
        required: true
        description: 分類 ID
        schema:
          type: string
          pattern: '^cat_[a-zA-Z0-9]+$'
      - name: update_mask
        in: query
        required: false
        description: 要更新的欄位清單（AIP-134 updateMask；以逗號分隔）
        schema:
          type: string
          example: "name,description,is_active"
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/category.yaml#/UpdateCategoryRequest'
    responses:
      '200':
        description: 分類更新成功
        content:
          application/json:
            schema:
              $ref: '../components/schemas/category.yaml#/Category'
      '400':
        $ref: '../components/responses/errors.yaml#/ValidationError'
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'
  
  delete:
    tags:
      - Categories
    summary: 刪除分類
    description: 刪除指定分類，需要管理員權限
    operationId: deleteCategory
    security:
      - OAuth2: ['write', 'admin']
      - ApiKeyBearer: []
    parameters:
      - name: id
        in: path
        required: true
        description: 分類 ID
        schema:
          type: string
          pattern: '^cat_[a-zA-Z0-9]+$'
    responses:
      '204':
        description: 分類刪除成功
      '400':
        $ref: '../components/responses/errors.yaml#/BadRequest'
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'

categories_products:
  get:
    tags:
      - Categories
    summary: 列出分類下的產品
    description: 取得指定分類下的產品列表（支援 AIP-160 篩選與分頁）
    operationId: listCategoryProducts
    parameters:
      - name: id
        in: path
        required: true
        description: 分類 ID
        schema:
          type: string
          pattern: '^cat_[a-zA-Z0-9]+$'
          example: "cat_electronics"
      - $ref: '../components/parameters/common.yaml#/PageSize'
      - $ref: '../components/parameters/common.yaml#/PageToken'
      - $ref: '../components/parameters/common.yaml#/Filter'
      - $ref: '../components/parameters/common.yaml#/OrderBy'
    responses:
      '200':
        description: 成功返回分類產品列表
        content:
          application/json:
            schema:
              $ref: '../components/schemas/product.yaml#/ProductList'
      '400':
        $ref: '../components/responses/errors.yaml#/BadRequest'
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'
      '500':
        $ref: '../components/responses/errors.yaml#/InternalError'
    security:
      - OAuth2: ['read']
      - ApiKeyBearer: []
