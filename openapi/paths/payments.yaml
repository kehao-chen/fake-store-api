# 支付處理 API 端點定義

payments_collection:
  post:
    tags:
      - Payments
    summary: 發起支付處理
    description: |
      為使用者的購物車或訂單建立 Stripe 支付意圖。
      
      ## 支付流程
      1. 驗證使用者認證和購物車內容
      2. 建立 Stripe PaymentIntent
      3. 返回 client_secret 供前端確認支付
      
      ## 支援的支付方式
      - 信用卡 (Visa, Mastercard, American Express)
      - Apple Pay, Google Pay (透過 Stripe)
      
    operationId: createPayment
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/payment.yaml#/CreatePaymentRequest'
          examples:
            cart_payment:
              summary: 購物車支付
              value:
                source_type: "cart"
                payment_method: "stripe"
                return_url: "https://example.com/payment/return"
            order_payment:
              summary: 訂單支付
              value:
                source_type: "order"
                source_id: "order_abc123"
                payment_method: "stripe"
                return_url: "https://example.com/payment/return"
    responses:
      '201':
        description: 支付意圖建立成功
        content:
          application/json:
            schema:
              $ref: '../components/schemas/payment.yaml#/PaymentResponse'
            examples:
              successful_payment_creation:
                summary: 成功建立支付
                value:
                  payment_id: "pay_abc123"
                  payment_intent:
                    id: "pi_3MqrF82eZvKYlo2C0KhoLsWy"
                    status: "requires_confirmation"
                    amount: 29999
                    currency: "usd"
                    client_secret: "pi_3MqrF82eZvKYlo2C0KhoLsWy_secret_abc123"
                  order_id: "order_abc123"
                  amount: 299.99
                  currency: "USD"
                  status: "pending"
      '400':
        $ref: '../components/responses/errors.yaml#/BadRequest'
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '402':
        $ref: '../components/responses/errors.yaml#/PaymentRequired'
      '422':
        description: 支付處理失敗
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/Error'
            examples:
              empty_cart:
                summary: 購物車為空
                value:
                  error:
                    code: "CART_EMPTY"
                    message: "Cannot process payment for empty cart"
                    details:
                      reason: "Cart contains no items"
                  request_id: "req_pay_123"
              insufficient_stock:
                summary: 庫存不足
                value:
                  error:
                    code: "INSUFFICIENT_STOCK"
                    message: "Some items in cart are out of stock"
                    details:
                      unavailable_items: ["prod_1a2b3c"]
                  request_id: "req_pay_124"
              invalid_amount:
                summary: 金額無效
                value:
                  error:
                    code: "INVALID_AMOUNT"
                    message: "Payment amount must be greater than 0"
                    details:
                      calculated_amount: 0
                  request_id: "req_pay_125"
      '500':
        $ref: '../components/responses/errors.yaml#/InternalError'

payments_item:
  get:
    tags:
      - Payments
    summary: 查詢支付狀態
    description: |
      查詢指定支付記錄的狀態和詳情。
      
      ## 支付狀態
      - `pending` - 等待支付
      - `processing` - 支付處理中
      - `succeeded` - 支付成功
      - `failed` - 支付失敗
      - `canceled` - 支付取消
      
      ## 權限要求
      使用者只能查詢自己的支付記錄。
      
    operationId: getPayment
    security:
      - BearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        description: 支付記錄 ID
        schema:
          type: string
          pattern: '^(pay_|pi_)[a-zA-Z0-9_]+$'
          example: "pay_abc123"
        examples:
          payment_id:
            summary: 支付記錄 ID
            value: "pay_abc123"
          stripe_payment_intent_id:
            summary: Stripe PaymentIntent ID
            value: "pi_3MqrF82eZvKYlo2C0KhoLsWy"
    responses:
      '200':
        description: 支付資訊
        content:
          application/json:
            schema:
              $ref: '../components/schemas/payment.yaml#/Payment'
            examples:
              successful_payment:
                summary: 支付成功
                value:
                  id: "pay_abc123"
                  stripe_payment_intent_id: "pi_3MqrF82eZvKYlo2C0KhoLsWy"
                  user_id: "user_123abc"
                  order_id: "order_abc123"
                  amount: 299.99
                  currency: "USD"
                  status: "succeeded"
                  payment_method: "stripe"
                  metadata:
                    source_type: "cart"
                  created_at: "2025-08-22T10:30:00Z"
                  updated_at: "2025-08-22T10:35:00Z"
              pending_payment:
                summary: 等待支付
                value:
                  id: "pay_def456"
                  stripe_payment_intent_id: "pi_3MqrF82eZvKYlo2C0KhoTest"
                  user_id: "user_456def"
                  order_id: "order_def456"
                  amount: 149.50
                  currency: "USD"
                  status: "pending"
                  payment_method: "stripe"
                  metadata:
                    source_type: "order"
                  created_at: "2025-08-22T11:00:00Z"
                  updated_at: "2025-08-22T11:00:00Z"
              failed_payment:
                summary: 支付失敗
                value:
                  id: "pay_ghi789"
                  stripe_payment_intent_id: "pi_3MqrF82eZvKYlo2C0KhoFail"
                  user_id: "user_789ghi"
                  order_id: "order_ghi789"
                  amount: 75.25
                  currency: "USD"
                  status: "failed"
                  payment_method: "stripe"
                  failure_reason: "card_declined"
                  metadata:
                    source_type: "cart"
                  created_at: "2025-08-22T09:15:00Z"
                  updated_at: "2025-08-22T09:16:00Z"
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        description: 無權限查看此支付記錄
        content:
          application/json:
            schema:
              $ref: '../components/schemas/common.yaml#/Error'
            examples:
              forbidden_access:
                summary: 無權限訪問
                value:
                  error:
                    code: "FORBIDDEN"
                    message: "You don't have permission to access this payment record"
                    details:
                      payment_id: "pay_abc123"
                      user_id: "user_different"
                  request_id: "req_pay_403"
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'
      '500':
        $ref: '../components/responses/errors.yaml#/InternalError'